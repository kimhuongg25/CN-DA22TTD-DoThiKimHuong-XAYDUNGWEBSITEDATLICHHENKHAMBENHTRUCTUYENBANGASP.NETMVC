@model PagedList.IPagedList<WebAppYte.Models.LichKham>
@using PagedList.Mvc;

@{
    ViewBag.Title = "Lịch khám của bạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var u = Session["user"] as WebAppYte.Models.NguoiDung;

    // === PHẦN SỬA LỖI: KIỂM TRA ĐĂNG NHẬP ===
    if (u == null)
    {
        Response.Redirect(Url.Action("DangNhap", "NguoiDung"));
    }
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<style>
    /* Custom CSS cho trang Lịch khám */
    .appointment-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 20px;
        transition: transform 0.2s;
        border-left: 5px solid #ddd; /* Màu mặc định */
    }

        .appointment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

    /* Màu viền theo trạng thái */
    .status-pending {
        border-left-color: #ffc107 !important;
    }
    /* Vàng */
    .status-confirmed {
        border-left-color: #0d6efd !important;
    }
    /* Xanh dương */
    .status-completed {
        border-left-color: #198754 !important;
    }
    /* Xanh lá */

    .avatar-wrapper img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #f8f9fa;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .info-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
    }

    .info-item {
        margin-bottom: 5px;
        color: #555;
        font-size: 1.5rem;
    }

        .info-item i {
            width: 25px;
            color: #0d6efd;
            text-align: center;
        }

    .filter-bar .btn {
        margin-right: 5px;
        border-radius: 20px;
        font-weight: 600;
    }

    .pagination-container {
        text-align: center;
        margin-top: 30px;
    }
</style>

@if (u != null)
{
    <div class="container py-4">
        <div class="row mb-4 align-items-center">
            <div class="col-md-6">
                <h2 class="text-primary"><i class="fas fa-calendar-check"></i> Lịch khám của bạn</h2>
            </div>
            <div class="col-md-6 text-right filter-bar" style="text-align: right;">
                <a href="@Url.Action("Create")" class="btn btn-warning shadow-sm">
                    <i class="fas fa-plus"></i> Đặt mới
                </a>
                <a href="@Url.Action("Dangxuly", "LichKham", new { id = u.IDNguoiDung })" class="btn btn-outline-secondary">
                    Đang chờ
                </a>
                <a href="@Url.Action("Daxacnhan", "LichKham", new { id = u.IDNguoiDung })" class="btn btn-outline-primary">
                    Đã xác nhận
                </a>
                <a href="@Url.Action("Datuvanxong", "LichKham", new { id = u.IDNguoiDung })" class="btn btn-outline-success">
                    Hoàn thành
                </a>
            </div>
        </div>

        <hr />

        <div class="row">
            @if (Model.Count == 0)
            {
                <div class="col-12 text-center py-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="100" style="opacity:0.5" />
                    <p class="text-muted mt-3">Bạn chưa có lịch khám nào trong danh sách này.</p>
                    <a href="@Url.Action("Create")" class="btn btn-primary">Đặt lịch ngay</a>
                </div>
            }

            @foreach (var item in Model)
            {
                // Xác định class CSS dựa trên trạng thái
                string statusClass = "status-pending";
                if (item.TrangThai == 1) { statusClass = "status-confirmed"; }
                else if (item.TrangThai == 2) { statusClass = "status-completed"; }

                <div class="col-12">
                    <div class="appointment-card @statusClass">
                        <div class="row align-items-center">

                            <div class="col-md-2 text-center avatar-wrapper">
                                <img src="~/images/images/avatar.jpg" alt="Avatar Bác sĩ" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3774/3774299.png'" />
                            </div>

                            <div class="col-md-6">
                                <div class="info-title">@item.QuanTri.HoTen</div>
                                <div class="info-item"><i class="fas fa-user-injured"></i> Bệnh nhân: <strong>@item.NguoiDung.HoTen</strong></div>
                                <div class="info-item"><i class="far fa-clock"></i> Thời gian: <strong>@(item.BatDau.HasValue ? item.BatDau.Value.ToString("dd/MM/yyyy - HH:mm") : "Chưa cập nhật")</strong></div>
                                <div class="info-item"><i class="fas fa-stethoscope"></i> Vấn đề: @item.ChuDe</div>

                                @if (item.TrangThai == 2)
                                {
                                    <div class="mt-2 p-2 bg-light rounded border text-muted">
                                        <small><i class="fas fa-sticky-note"></i> <b>Ghi chú bác sĩ:</b> @item.KetQuaKham</small>
                                    </div>
                                }
                            </div>

                            <div class="col-md-4 text-center d-flex flex-column justify-content-center">

                                @if (item.TrangThai == 0)
                                {
                                    <div class="mb-3">
                                        <span class="badge bg-warning text-dark p-2" style="font-size:14px">
                                            <i class="fas fa-hourglass-half"></i> Chờ xác nhận
                                        </span>
                                    </div>
                                    <div class="btn-group">
                                        <a href="@Url.Action("Edit", new { id = item.IDLichKham })" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i> Sửa
                                        </a>
                                        <a href="@Url.Action("Delete", new { id = item.IDLichKham })" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash"></i> Hủy
                                        </a>
                                    </div>
                                }
                                else if (item.TrangThai == 1)
                                {
                                    <div class="mb-3">
                                        <span class="badge bg-primary p-2" style="font-size:14px">
                                            <i class="fas fa-check-circle"></i> Đã xác nhận
                                        </span>
                                    </div>

                                    if (item.BatDau.HasValue)
                                    {
                                        DateTime now = DateTime.Now;
                                        DateTime bd = item.BatDau.Value;
                                        int sosanh = DateTime.Compare(now, bd);

                                        if (sosanh < 0)
                                        {
                                            TimeSpan i = bd.Subtract(now);
                                            <div class="alert alert-info py-1 mb-0" style="font-size: 13px;">
                                                Sắp diễn ra trong:<br />
                                                <b>@i.Days ngày @i.Hours giờ @i.Minutes phút</b>
                                            </div>
                                        }
                                     
                                    }
                                }
                                else if (item.TrangThai == 2)
                                {
                                    <div class="mb-3">
                                        <span class="badge bg-success p-2" style="font-size:14px">
                                            <i class="fas fa-check-double"></i> Đã hoàn thành
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Lỗi dữ liệu</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="pagination-container">
            Trang @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount
            <div class="d-flex justify-content-center mt-2">
                @Html.PagedListPager(Model, page => Url.Action("Index", new { page }))
            </div>
        </div>
    </div>
}