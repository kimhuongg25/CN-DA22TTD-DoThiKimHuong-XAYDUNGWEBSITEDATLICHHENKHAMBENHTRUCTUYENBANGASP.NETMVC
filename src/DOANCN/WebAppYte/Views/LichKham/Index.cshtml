@model PagedList.IPagedList<WebAppYte.Models.LichKham>
@using PagedList.Mvc;

@{
    ViewBag.Title = "Lịch khám của bạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var u = Session["user"] as WebAppYte.Models.NguoiDung;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<style>
    /* Custom CSS */
    .appointment-card {
        background: #fff;
        border-radius: 12px; /* Bo góc tròn hơn chút */
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        margin-bottom: 25px;
        padding: 25px; /* Tăng khoảng cách đệm */
        transition: transform 0.2s;
        border-left: 6px solid #ddd;
    }

        .appointment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

    /* Màu trạng thái */
    .status-pending {
        border-left-color: #ffc107 !important;
    }

    .status-confirmed {
        border-left-color: #0d6efd !important;
    }

    .status-completed {
        border-left-color: #198754 !important;
    }

    .avatar-wrapper img {
        width: 130px; /* Ảnh to hơn */
        height: 130px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #f8f9fa;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* TÊN BÁC SĨ - To và Đậm */
    .info-title {
        font-size: 1.5rem; /* ~24px */
        font-weight: 800;
        color: #2c3e50;
        margin-bottom: 10px;
    }

    /* THÔNG TIN CHI TIẾT - Chữ to dễ đọc */
    .info-item {
        margin-bottom: 8px;
        color: #444;
        font-size: 1.5rem; /* ~18px */
        line-height: 1.6;
    }

        .info-item i {
            width: 30px;
            color: #0d6efd;
            text-align: center;
            font-size: 1.2rem;
        }

    /* Nút lọc */
    .filter-bar .btn {
        margin-right: 8px;
        border-radius: 30px;
        font-weight: 600;
        font-size: 1rem;
        padding: 8px 20px;
    }

    .pagination-container {
        text-align: center;
        margin-top: 40px;
        font-size: 1.1rem;
    }

    /* Badge trạng thái to hơn */
    .badge-status {
        font-size: 1rem !important;
        padding: 10px 15px !important;
        border-radius: 8px;
        font-weight: 600;
        display: inline-block;
        width: 100%;
    }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<div class="container py-4">

    <div class="row mb-4 align-items-center">
        <div class="col-md-5">
            <h2 class="text-primary" style="font-weight:800;font-size:2rem">
                <i class="fas fa-calendar-check"></i> Lịch khám của bạn
            </h2>
        </div>

        <div class="col-md-7 text-end">
            <a href="@Url.Action("Create")" class="btn btn-warning shadow-sm">
                <i class="fas fa-plus"></i> Đặt mới
            </a>

            @if (u != null)
            {
                <a href="@Url.Action("Dangxuly","LichKham",new { id = u.IDNguoiDung })"
                   class="btn btn-outline-secondary">Đang chờ</a>

                <a href="@Url.Action("Daxacnhan","LichKham",new { id = u.IDNguoiDung })"
                   class="btn btn-outline-primary">Đã xác nhận</a>

                <a href="@Url.Action("Datuvanxong","LichKham",new { id = u.IDNguoiDung })"
                   class="btn btn-outline-success">Hoàn thành</a>
            }
        </div>
    </div>

    <hr />

    @* CHƯA ĐĂNG NHẬP *@
    @if (u == null)
    {
        <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle"></i>
            Vui lòng đăng nhập để xem lịch khám.
        </div>
    }
    else if (Model == null || !Model.Any())
    {
        <div class="text-center py-5 text-muted">
            <p>Bạn chưa có lịch khám nào.</p>
            <a href="@Url.Action("Create")" class="btn btn-primary btn-lg">Đặt lịch ngay</a>
        </div>
    }
    else
    {
        foreach (var item in Model)
        {
            {
                string statusClass = "status-pending";

                if (item.TrangThai == 1)
                {
                    statusClass = "status-confirmed";
                }
                else if (item.TrangThai == 2)
                {
                    statusClass = "status-completed";
                }
            }

            <div class="appointment-card statusClass mb-4">

                <div class="row align-items-center">

                    <div class="col-md-2 text-center avatar-wrapper">
                        <img src="~/images/images/avatar.jpg"
                             onerror="this.src='https://cdn-icons-png.flaticon.com/512/3774/3774299.png'" />
                    </div>

                    <div class="col-md-6">

                        <div class="info-title">
                            @(item.QuanTri != null ? item.QuanTri.HoTen : "Chưa phân công bác sĩ")
                        </div>

                        <div class="info-item">
                            <i class="fas fa-user-injured"></i>
                            Bệnh nhân:
                            <strong>@(item.NguoiDung?.HoTen ?? "Không xác định")</strong>
                        </div>

                        <div class="info-item">
                            <i class="far fa-clock"></i>
                            Thời gian:
                            <strong>
                                @(item.BatDau.HasValue
                                    ? item.BatDau.Value.ToString("dd/MM/yyyy - HH:mm")
                                    : "Chưa xác định")
                            </strong>
                        </div>

                        <div class="info-item">
                            <i class="fas fa-stethoscope"></i>
                            Vấn đề: @item.ChuDe
                        </div>

                        @if (item.TrangThai == 2 && !string.IsNullOrEmpty(item.KetQuaKham))
                        {
                            <div class="mt-3 p-3 bg-light rounded border text-muted">
                                <i class="fas fa-sticky-note text-warning"></i>
                                <b>Ghi chú bác sĩ:</b> @item.KetQuaKham
                            </div>
                        }
                    </div>

                    <div class="col-md-4 text-center">

                        @if (item.TrangThai == 0)
                        {
                            <span class="badge bg-warning text-dark badge-status mb-3">
                                <i class="fas fa-hourglass-half"></i> Chờ xác nhận
                            </span>

                            <a href="@Url.Action("Edit", new { id = item.IDLichKham })"
                               class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-edit"></i> Chỉnh sửa
                            </a>

                            <a href="@Url.Action("Delete", new { id = item.IDLichKham })"
                               class="btn btn-outline-danger w-100">
                                <i class="fas fa-trash"></i> Hủy lịch
                            </a>
                        }
                        else if (item.TrangThai == 1)
                        {
                            <span class="badge bg-primary badge-status mb-3">
                                <i class="fas fa-check-circle"></i> Đã xác nhận
                            </span>

                            if (item.BatDau.HasValue)
                            {
                                DateTime now = DateTime.Now;
                                DateTime bd = item.BatDau.Value;

                                if (now < bd)
                                {
                                    TimeSpan i = bd - now;
                                    <div class="alert alert-info py-2">
                                        Sắp diễn ra trong:<br />
                                        <b>@i.Days ngày @i.Hours giờ @i.Minutes phút</b>
                                    </div>
                                }
               
                            }
                        }
                        else
                        {
                            <span class="badge bg-success badge-status">
                                <i class="fas fa-check-double"></i> Đã hoàn thành
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    }

    @if (Model != null && Model.PageCount > 1)
    {
        <div class="pagination-container">
            Trang @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount
            <div class="d-flex justify-content-center mt-3">
                @Html.PagedListPager(Model, page => Url.Action("Index", new { page }))
            </div>
        </div>
    }
</div>